<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>N√ñ ‚Ä¢ 14-Tage-Niederschlag (Client-Rendering)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<style>
  :root{ --pad: max(12px, env(safe-area-inset-top, 0)); }
  html,body,#map{height:100%;margin:0}
  .stack-left{
    position:fixed; z-index:1000;
    top: calc(env(safe-area-inset-top, 0) + 12px);
    left: calc(env(safe-area-inset-left, 0) + 12px);
    display:flex; flex-direction:column; gap:8px;
  }
  .btn{
    background:#fff; padding:8px 12px; border-radius:10px; border:1px solid #e5e5e5;
    box-shadow:0 2px 8px rgba(0,0,0,.12);
    font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:14px;
  }
  #fab{
    position:fixed; z-index:1001;
    top: calc(env(safe-area-inset-top, 0) + 12px);
    right: calc(env(safe-area-inset-right, 0) + 12px);
    width:42px; height:42px; border-radius:50%;
    display:grid; place-items:center;
  }
  #drawer{
    position:fixed; z-index:1000;
    top: calc(env(safe-area-inset-top, 0) + 60px);
    right: calc(env(safe-area-inset-right, 0) + 12px);
    width:min(360px, 94vw); max-height:72vh; overflow:auto;
    background:#fff; border:1px solid #e5e5e5; border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.18);
    transform: translateX(110%); transition: transform .22s ease-out;
    padding:12px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:14px;
  }
  #drawer.open{ transform:none; }
  #drawer .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:8px; }
  #drawer .kb{ min-width:32px; height:28px; border:1px solid #ddd; border-radius:6px; background:#fafafa }
  #drawer code{ background:#f3f3f3; padding:1px 6px; border-radius:4px }
  #toast{
    position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:1002;
    background:#111; color:#fff; padding:8px 12px; border-radius:8px; opacity:.92; display:none;
    font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:13px;
  }
  label{font-size:12px}
  .hint{font-size:12px; opacity:.7}
  input[type="date"]{padding:4px 6px; border:1px solid #ddd; border-radius:6px; font:14px system-ui}
  .progress{height:6px; background:#eee; border-radius:999px; overflow:hidden; width:100%}
  .bar{height:100%; width:0%; background:#4f46e5; transition:width .15s}
</style>
</head>
<body>
  <div id="map"></div>

  <!-- Linke Buttons -->
  <div class="stack-left">
    <button class="btn" id="loc">üìç Meine Position</button>
    <button class="btn" id="reset">‚Ü∫ Ansicht/Reset</button>
  </div>

  <!-- Gear √∂ffnen/schlie√üen -->
  <button class="btn" id="fab" aria-label="Einstellungen">‚öôÔ∏è</button>

  <!-- Panel -->
  <div id="drawer" aria-hidden="true">
    <div class="row" style="justify-content:space-between; width:100%">
      <div>
        <div><strong>Overlay aus API rendern (Client)</strong></div>
        <div class="hint">SPARTACUS v2 RR ‚Ä¢ GeoSphere Dataset-API</div>
      </div>
      <button class="kb" id="renderBtn">Laden &amp; Rendern</button>
    </div>

    <div class="row">
      <label>Von: <input type="date" id="start"></label>
      <label>Bis: <input type="date" id="end"></label>
    </div>

    <div class="row">
      <label>BBOX&nbsp;<span class="hint">(s,w,n,e)</span>:</label>
      <input id="bbox" style="flex:1;min-width:200px;padding:6px;border:1px solid #ddd;border-radius:6px"
             value="47.419564822,14.450844322,49.024548178,17.075640678">
    </div>

    <div class="row" style="width:100%">
      <div class="progress" style="flex:1"><div class="bar" id="bar"></div></div>
      <div style="min-width:52px;text-align:right"><code id="pct">0%</code></div>
    </div>

    <div class="row">
      <label>Overlay&nbsp;<input type="range" id="opacity" min="30" max="100" value="85">
        <span id="ovv">85%</span></label>
      <label><input type="checkbox" id="showBounds"> Bounds-Rahmen</label>
    </div>

    <div style="margin:6px 0;border-top:1px solid #eee"></div>
    <div class="row"><strong>Manuelle Justierung</strong> <span class="hint">(persistiert lokal)</span></div>

    <div class="row">
      <small>Shift X:</small>
      <button class="kb" id="left">‚Üê</button>
      <div><code id="pxX">0</code>&nbsp;px</div>
      <button class="kb" id="right">‚Üí</button>
    </div>

    <div class="row">
      <small>Shift Y:</small>
      <button class="kb" id="up">‚Üë</button>
      <div><code id="pxY">0</code>&nbsp;px</div>
      <button class="kb" id="down">‚Üì</button>
      <small class="hint">(‚Üë = nach Norden)</small>
    </div>

    <div class="row">
      <small>Breite (W):</small>
      <button class="kb" id="wMinus">W‚àí</button>
      <div><code id="wPct">0.0</code>&nbsp;%</div>
      <button class="kb" id="wPlus">W+</button>
    </div>

    <div class="row">
      <small>H√∂he (H):</small>
      <button class="kb" id="hMinus">H‚àí</button>
      <div><code id="hPct">0.0</code>&nbsp;%</div>
      <button class="kb" id="hPlus">H+</button>
    </div>
  </div>

  <div id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ======== Konfig ======== */
var DATASET_URL = "https://dataset.api.hub.geosphere.at/v1/grid/historical/spartacus-v2-1d-1km";
var PARAM = "RR";

/* ======== UI & Map ======== */
function toast(msg){ var el = document.getElementById('toast'); el.textContent = msg; el.style.display='block';
                     clearTimeout(el._t); el._t = setTimeout(function(){ el.style.display='none'; }, 2200); }

var map = L.map('map', { zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);

var fab = document.getElementById('fab');
var drawer = document.getElementById('drawer');
fab.addEventListener('click', function(){
  var open = !drawer.classList.contains('open');
  drawer.classList.toggle('open', open);
  drawer.setAttribute('aria-hidden', String(!open));
});

/* ======== Datum default: letzte 14 Tage ======== */
var startEl = document.getElementById('start');
var endEl = document.getElementById('end');
(function setDefaultDates(){
  var today = new Date();
  var end = new Date(today.getFullYear(), today.getMonth(), today.getDate()-1); // gestern
  var start = new Date(end); start.setDate(end.getDate()-13);
  function fmt(d){ return d.toISOString().slice(0,10); }
  startEl.value = fmt(start);
  endEl.value = fmt(end);
})();

/* ======== Renderer-States ======== */
var overlay = null;      // Leaflet imageOverlay
var rect = null;         // Debug-bounds rectangle
var baseBounds = null;   // Leaflet LatLngBounds
var baseBoundsObj = null;

/* ======== Progress-Bar ======== */
var bar = document.getElementById('bar');
var pct = document.getElementById('pct');
function progress(frac){ var p = Math.max(0, Math.min(1, frac||0)); bar.style.width = (Math.round(p*100))+'%'; pct.textContent = (Math.round(p*100))+'%'; }

/* ======== Farbskala ======== */
var STOPS = [
  {t:0.00, c:[68,1,84]},
  {t:0.20, c:[71,44,122]},
  {t:0.40, c:[59,81,139]},
  {t:0.60, c:[44,113,142]},
  {t:0.80, c:[33,144,141]},
  {t:1.00, c:[253,231,37]}
];
function lerp(a,b,t){ return a + (b-a)*t; }
function lerpColor(c1,c2,t){ return [Math.round(lerp(c1[0],c2[0],t)), Math.round(lerp(c1[1],c2[1],t)), Math.round(lerp(c1[2],c2[2],t))]; }
function colorFor(v, vmin, vmax){
  if (!isFinite(v)) return [0,0,0,0];
  var t = Math.max(0, Math.min(1, (v - vmin) / (vmax - vmin + 1e-9)));
  var i = 0; while (i < STOPS.length-1 && t > STOPS[i+1].t) i++;
  var t0 = STOPS[i].t, t1 = STOPS[i+1].t;
  var local = (t - t0) / (t1 - t0);
  var rgb = lerpColor(STOPS[i].c, STOPS[i+1].c, local);
  return [rgb[0], rgb[1], rgb[2], 255];
}

/* ======== FeatureCollection laden & summieren ======== */
function loadFeatureCollection(start, end, bbox){
  var params = new URLSearchParams({ parameters: PARAM, start: start, end: end, bbox: bbox.join(',') });
  return fetch(DATASET_URL + "?" + params.toString(), { headers: { "Accept":"application/json" } })
    .then(function(r){
      if (!r.ok) return r.text().then(function(t){ throw new Error("HTTP "+r.status+" "+t); });
      return r.json();
    }).then(function(fc){
      if (!fc || fc.type !== "FeatureCollection" || !Array.isArray(fc.features)) throw new Error("Keine FeatureCollection erhalten.");
      return fc;
    });
}

function extractValues(props, nt){
  var prefer = [PARAM, String(PARAM).toLowerCase(), "RRsum","rr_sum","value","values"];
  for (var i=0;i<prefer.length;i++){
    var v = props[prefer[i]];
    if (Array.isArray(v) && v.length>0) {
      var out = []; for (var j=0;j<v.length;j++){ var x=v[j]; if (typeof x==='number' && isFinite(x)) out.push(Number(x)); }
      if (out.length>0) return out;
    }
  }
  var keys = Object.keys(props);
  for (var k=0;k<keys.length;k++){
    var v2 = props[keys[k]];
    if (Array.isArray(v2) && v2.length===nt) {
      var out2 = []; for (var j2=0;j2<v2.length;j2++){ var y=v2[j2]; if (typeof y==='number' && isFinite(y)) out2.push(Number(y)); }
      if (out2.length>0) return out2;
    }
  }
  var found = null;
  function scan(o){
    if (found) return;
    if (Array.isArray(o)){
      if (o.length>0){
        var num = false;
        for (var q=0;q<o.length;q++){ if (typeof o[q]==='number' && isFinite(o[q])) { num=true; break; } }
        if (num){ found = o.map(function(z){ return Number(z); }); return; }
      }
      for (var q2=0;q2<o.length;q2++) scan(o[q2]);
    } else if (o && typeof o === 'object'){
      var ks = Object.keys(o);
      for (var m=0;m<ks.length;m++) scan(o[ks[m]]);
    }
  }
  scan(props);
  return found;
}

function bboxFromGeom(geom){
  var coords = geom && geom.coordinates;
  var minx=Infinity,miny=Infinity,maxx=-Infinity,maxy=-Infinity;
  function walk(node){
    if (!node) return;
    if (Array.isArray(node)) {
      if (node.length>=2 && typeof node[0]==='number' && typeof node[1]==='number'){
        var x=node[0], y=node[1];
        if (x<minx) minx=x; if (x>maxx) maxx=x; if (y<miny) miny=y; if (y>maxy) maxy=y;
      } else {
        for (var i=0;i<node.length;i++) walk(node[i]);
      }
    }
  }
  walk(coords);
  return [minx,miny,maxx,maxy];
}
function quantile(sorted, q){
  // sorted: bereits sortiertes Zahlen-Array
  if (!sorted.length) return NaN;
  var pos = (sorted.length - 1) * q;
  var base = Math.floor(pos);
  var rest = pos - base;
  if (sorted[base+1] !== undefined) return sorted[base] + rest * (sorted[base+1] - sorted[base]);
  return sorted[base];
}
function robustRange(vals){
  // 2%‚Äì98% Stretch, fallback auf echtes Min/Max
  var arr = [];
  for (var i=0;i<vals.length;i++) if (isFinite(vals[i])) arr.push(vals[i]);
  if (!arr.length) return {vmin:0, vmax:1};
  arr.sort(function(a,b){return a-b;});
  var v2 = quantile(arr, 0.02);
  var v98 = quantile(arr, 0.98);
  if (!isFinite(v2) || !isFinite(v98) || v98 <= v2) { v2 = arr[0]; v98 = arr[arr.length-1]; }
  if (v98 <= v2) { v98 = v2 + 1e-6; }
  return { vmin: v2, vmax: v98 };
}

/* ======== Canvas-Rasterizer ======== */
function renderToCanvas(cells, bounds){
  var PX_W = 1536;
  var widthDeg  = bounds.east - bounds.west;
  var heightDeg = bounds.north - bounds.south;
  var PX_H = Math.max(1, Math.round(PX_W * (heightDeg/widthDeg)));

  var cvs = document.createElement('canvas');
  cvs.width = PX_W; cvs.height = PX_H;
  var ctx = cvs.getContext('2d', { willReadFrequently: false });
  ctx.imageSmoothingEnabled = false;

  var img = ctx.createImageData(PX_W, PX_H);
  var data = img.data;

  var lonPerPx = widthDeg / PX_W;
  var latPerPx = heightDeg / PX_H;

  // --- Wertebereich robust bestimmen (2‚Äì98 %) ---
  var vals = new Array(cells.length);
  for (var i=0;i<cells.length;i++) vals[i] = cells[i].v;
  var rr = robustRange(vals);
  var vmin = rr.vmin, vmax = rr.vmax;

  // Debug ins Console/Toast
  console.log("RR Range (robust):", vmin, "‚Ä¶", vmax, "| N=", cells.length);

  var done = 0;
  for (var c=0;c<cells.length;c++){
    var cell = cells[c];

    // Pixelrechteck aus Geo-BBOX
    var minx = Math.max(0, Math.floor((cell.minx - bounds.west)/lonPerPx));
    var maxx = Math.min(PX_W-1, Math.ceil ((cell.maxx - bounds.west)/lonPerPx));
    var miny = Math.max(0, Math.floor((bounds.north - cell.maxy)/latPerPx));
    var maxy = Math.min(PX_H-1, Math.ceil ((bounds.north - cell.miny)/latPerPx));

    // Farbe
    var col = colorFor(cell.v, vmin, vmax); // [r,g,b,255]
    var r = col[0], g = col[1], b = col[2], a = 255;

    // F√ºllen
    for (var y=miny; y<=maxy; y++){
      var idx = (y*PX_W + minx)*4;
      for (var x=minx; x<=maxx; x++){
        data[idx]   = r; data[idx+1] = g; data[idx+2] = b; data[idx+3] = a;
        idx += 4;
      }
    }

    done++;
    if ((done % 500) === 0) progress(done / cells.length);
  }

  ctx.putImageData(img, 0, 0);
  progress(1);
  return { canvas: cvs, width: PX_W, height: PX_H };
}

/* ======== Overlay-Justage ======== */
var state = {
  shiftX: Number(localStorage.getItem('ovShiftX') || 0) || 0,
  shiftY: Number(localStorage.getItem('ovShiftY') || 0) || 0,
  scaleW: Number(localStorage.getItem('ovScaleW') || 0) || 0,
  scaleH: Number(localStorage.getItem('ovScaleH') || 0) || 0,
};
var pxX = document.getElementById('pxX'), pxY = document.getElementById('pxY');
var wPct = document.getElementById('wPct'), hPct = document.getElementById('hPct');
function updateUI(){ pxX.textContent = state.shiftX; pxY.textContent = state.shiftY; wPct.textContent = state.scaleW.toFixed(1); hPct.textContent = state.scaleH.toFixed(1); }

function applyTransformOnOverlay(ov, base){
  if (!ov || !ov._image) return;
  var B = base; var w0 = (B.east - B.west); var h0 = (B.north - B.south);
  var cx = B.west + w0/2, cy = B.south + h0/2;

  var wdeg = w0 * (1 + state.scaleW/100);
  var hdeg = h0 * (1 + state.scaleH/100);

  var wpx = ov._image.naturalWidth  || 0;
  var hpx = ov._image.naturalHeight || 0;
  var lonPerPx = wpx ? (w0 / wpx) : 0;
  var latPerPx = hpx ? (h0 / hpx) : 0;

  var dLon = state.shiftX * lonPerPx;
  var dLat = state.shiftY * latPerPx;

  var west  = (cx - wdeg/2) + dLon;
  var east  = (cx + wdeg/2) + dLon;
  var south = (cy - hdeg/2) + dLat;
  var north = (cy + hdeg/2) + dLat;

  var adj = L.latLngBounds([south, west], [north, east]);
  ov.setBounds(adj);
  if (rect && document.getElementById('showBounds').checked) rect.setBounds(adj);
}

function persist(){
  localStorage.setItem('ovShiftX', String(state.shiftX));
  localStorage.setItem('ovShiftY', String(state.shiftY));
  localStorage.setItem('ovScaleW', String(state.scaleW));
  localStorage.setItem('ovScaleH', String(state.scaleH));
  updateUI(); applyTransformOnOverlay(overlay, baseBoundsObj);
}

/* ======== Render-Button ======== */
document.getElementById('renderBtn').addEventListener('click', function(){
  progress(0); toast("Lade Daten ‚Ä¶");
  try{
    var start = startEl.value; var end = endEl.value;
    var bboxStr = document.getElementById('bbox').value.trim();
    var partsStr = bboxStr.split(',');
    if (partsStr.length !== 4) { alert("BBOX-Format: south,west,north,east"); return; }
    var parts = [];
    for (var i=0;i<4;i++){ var p = parseFloat(partsStr[i]); if (!isFinite(p)) { alert("BBOX ung√ºltig"); return; } parts.push(p); }
    var south = parts[0], west = parts[1], north = parts[2], east = parts[3];
    baseBoundsObj = {south:south, west:west, north:north, east:east};
    baseBounds = L.latLngBounds([south,west],[north,east]);

    loadFeatureCollection(start, end, parts).then(function(fc){
      var timestamps = fc.timestamps || [];
      var nt = timestamps.length;

      // FC -> Zellen
      var feats = fc.features || [];
      var cells = [];
      for (var i=0;i<feats.length;i++){
        var f = feats[i];
        var geom = f && f.geometry;
        if (!geom) continue;
        var props = f.properties || {};
        var vals = extractValues(props, nt);
        if (!vals) continue;
        var sum = 0;
        for (var j=0;j<vals.length;j++){ var vv = vals[j]; if (isFinite(vv)) sum += vv; }
        var bb = bboxFromGeom(geom);
        cells.push({ v: sum, minx: bb[0], miny: bb[1], maxx: bb[2], maxy: bb[3] });
        if ((i % 500) === 0) progress(i / feats.length);
      }

      toast("Zellen: " + cells.length);
      var rr = renderToCanvas(cells, baseBoundsObj);
      var url = rr.canvas.toDataURL("image/png");

      if (overlay) { try{ map.removeLayer(overlay); }catch(e){} }
      overlay = L.imageOverlay(url, baseBounds, { opacity: 0.85 }).addTo(map);
      overlay.on('load', function(){ applyTransformOnOverlay(overlay, baseBoundsObj); });
      map.fitBounds(baseBounds.pad(0.1));
    }).catch(function(err){
      console.error(err);
      alert("Fehler beim Laden/Rendern: " + (err && err.message ? err.message : err));
    });
  } catch(e){
    console.error(e);
    alert("Fehler beim Laden/Rendern: " + (e && e.message ? e.message : e));
  }
});

/* ======== Opazit√§t & Bounds-Rahmen ======== */
var op = document.getElementById('opacity'), ovv = document.getElementById('ovv');
op.addEventListener('input', function(){ if (overlay) overlay.setOpacity(Number(op.value)/100); ovv.textContent = op.value + '%'; });
document.getElementById('showBounds').addEventListener('change', function(){
  var checked = document.getElementById('showBounds').checked;
  if (checked) { rect = L.rectangle(overlay? overlay._bounds: baseBounds, { color: 'red', weight: 1 }).addTo(map); }
  else { if (rect) { map.removeLayer(rect); rect = null; } }
});

/* ======== Justage-UI ======== */
document.getElementById('left').addEventListener('click',  function(){ state.shiftX -= 1; persist(); });
document.getElementById('right').addEventListener('click', function(){ state.shiftX += 1; persist(); });
document.getElementById('up').addEventListener('click',    function(){ state.shiftY += 1; persist(); });
document.getElementById('down').addEventListener('click',  function(){ state.shiftY -= 1; persist(); });
document.getElementById('wMinus').addEventListener('click',function(){ state.scaleW -= 0.5; persist(); });
document.getElementById('wPlus').addEventListener('click', function(){ state.scaleW += 0.5; persist(); });
document.getElementById('hMinus').addEventListener('click',function(){ state.scaleH -= 0.5; persist(); });
document.getElementById('hPlus').addEventListener('click', function(){ state.scaleH += 0.5; persist(); });
updateUI();

/* ======== Reset/Ansicht & Geolocation ======== */
document.getElementById('reset').addEventListener('click', function(){
  state.shiftX = state.shiftY = 0; state.scaleW = state.scaleH = 0;
  persist(); if (overlay) map.fitBounds((overlay._bounds || baseBounds).pad(0.1)); toast("Zur√ºckgesetzt");
});

var watchId = null, gpsMarker = null, accCircle = null, firstFix = true;
function startWatch(){
  if (watchId !== null) return;
  watchId = navigator.geolocation.watchPosition(function(pos){
    var latitude = pos.coords.latitude, longitude = pos.coords.longitude, accuracy = pos.coords.accuracy;
    if (!gpsMarker) gpsMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("Du bist hier");
    gpsMarker.setLatLng([latitude, longitude]);
    if (accCircle) map.removeLayer(accCircle);
    accCircle = L.circle([latitude, longitude], accuracy, {opacity:0.6, fillOpacity:0.08}).addTo(map);
    if (firstFix) { map.setView([latitude, longitude], Math.max(map.getZoom(), 12)); firstFix = false; }
  }, function(err){
    if (err.code === err.PERMISSION_DENIED) toast("Standort verweigert. Safari: aA ‚Üí Website-Einstellungen ‚Üí Standort: Erlauben");
    else toast("GPS-Fehler: " + err.message);
  }, { enableHighAccuracy:true, maximumAge:10000, timeout:15000 });
}
function requestOnceThenWatch(){
  return new Promise(function(res, rej){
    navigator.geolocation.getCurrentPosition(function(){ res(); }, function(e){ rej(e); },
      { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
  }).then(function(){ startWatch(); document.getElementById('loc').textContent = "üìç GPS aktiv"; toast("GPS aktiv"); })
    .catch(function(e){ if (e && e.code === e.PERMISSION_DENIED) toast("Standort blockiert. iOS: Ortungsdienste f√ºr Safari freigeben.");
                        else toast("GPS-Fehler: " + (e && e.message ? e.message : e)); });
}
document.getElementById('loc').addEventListener('click', function(){
  if (!('geolocation' in navigator)) { toast("Geolocation nicht verf√ºgbar"); return; }
  if (watchId === null) requestOnceThenWatch();
  else {
    navigator.geolocation.clearWatch(watchId);
    watchId = null; firstFix = true;
    if (gpsMarker) { map.removeLayer(gpsMarker); gpsMarker = null; }
    if (accCircle) { map.removeLayer(accCircle); accCircle = null; }
    document.getElementById('loc').textContent = "üìç Meine Position";
    toast("GPS aus");
  }
});
</script>
</body>
</html>
