<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>N√ñ ‚Ä¢ 14-Tage-Niederschlag</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .locate-btn { position:absolute; top:12px; left:12px; z-index:1000; background:#fff; padding:6px 10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.3); font-family:system-ui,-apple-system; }
    .opacity { position:absolute; top:12px; right:12px; z-index:1000; background:#fff; padding:6px 10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.3); font-family:system-ui,-apple-system; }
    label { font-size:12px; }
  </style>
</head>
<body>
<div id="map"></div>
<button class="locate-btn" id="locBtn">üìç Meine Position</button>
<div class="opacity">
  <label>Overlay&nbsp;<input type="range" id="opacity" min="30" max="100" value="85"> <span id="ovv">85%</span></label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-2QQ7mRwyZ2f7jXtE2QbZ1I2QpYl6CkMDsC19iGd8+9w=" crossorigin="anonymous"></script>
<script>
(async function () {
  // TODO: ggf. Dateinamen anpassen:
  const PNG_URL = "noe_rr_sum_2025-08-14_bis_2025-08-27.png";
  const BOUNDS_URL = "overlay_bounds.json";

  const bounds = await fetch(BOUNDS_URL).then(r => r.json());
  const southWest = L.latLng(bounds.south, bounds.west);
  const northEast = L.latLng(bounds.north, bounds.east);
  const imgBounds = L.latLngBounds(southWest, northEast);

  const map = L.map('map', { zoomControl: true });
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const overlay = L.imageOverlay(PNG_URL, imgBounds, { opacity: 0.85, interactive: false }).addTo(map);
  map.fitBounds(imgBounds.pad(0.1));

  // Geolocation
  const me = L.marker([0,0], {opacity:0}).addTo(map);
  let watching = false;
  const locBtn = document.getElementById('locBtn');
  const opacity = document.getElementById('opacity');
  const ovv = document.getElementById('ovv');

  function updateOpacity() {
    const v = Number(opacity.value)/100;
    overlay.setOpacity(v);
    ovv.textContent = `${Math.round(v*100)}%`;
  }
  opacity.addEventListener('input', updateOpacity);
  updateOpacity();

  locBtn.addEventListener('click', () => {
    if (navigator.geolocation) {
      if (!watching) {
        watching = true;
        navigator.geolocation.watchPosition(pos => {
          const { latitude, longitude } = pos.coords;
          me.setLatLng([latitude, longitude]).setOpacity(1).bindPopup("Du bist hier");
        }, err => alert("GPS-Fehler: "+err.message), { enableHighAccuracy:true, maximumAge:10000, timeout:15000 });
        locBtn.textContent = "üìç GPS aktiv";
      } else {
        watching = false;
        me.setOpacity(0);
        locBtn.textContent = "üìç Meine Position";
      }
    } else {
      alert("Geolocation wird nicht unterst√ºtzt.");
    }
  });
})();
</script>
</body>
</html>