<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>N√ñ ‚Ä¢ 14-Tage-Niederschlag</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <style>
    html,body,#map{height:100%;margin:0}
    .ui{position:absolute;z-index:1000;background:#fff;padding:6px 10px;border-radius:8px;
        box-shadow:0 2px 8px rgba(0,0,0,.2);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #loc{top:12px;left:12px}
    #reset{top:58px;left:12px}
    #panel{top:12px;right:12px;min-width:210px}
    #panel .row{display:flex;align-items:center;gap:8px;margin-top:6px}
    #panel .row small{opacity:.7}
    #panel button.kb{width:28px;height:28px;border:1px solid #ddd;border-radius:6px;background:#fafafa}
    label{font-size:12px}
    #toast{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);z-index:1001;
           background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:.92;display:none}
  </style>
</head>
<body>
  <div id="map"></div>

  <button class="ui" id="loc">üìç Meine Position</button>
  <button class="ui" id="reset">‚Ü∫ Ansicht</button>

  <div class="ui" id="panel">
    <div class="row">
      <label>Overlay&nbsp;<input type="range" id="opacity" min="30" max="100" value="85">
        <span id="ovv">85%</span></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="showBounds"> Bounds-Rahmen</label>
    </div>
    <div class="row">
      <small>Feinjustierung X:</small>
      <button class="kb" id="left">‚Üê</button>
      <div><code id="pxVal">0</code>&nbsp;px</div>
      <button class="kb" id="right">‚Üí</button>
    </div>
  </div>

  <div id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
  // ===== KONFIG ==============================================================
  // PNG liegt im gleichen Ordner wie diese Datei (Root oder docs/, je nach Pages)
  const PNG_URL = "noe_rr_sum_2025-08-14_bis_2025-08-27.png";

  // Fallback-Bounds, falls overlay_bounds.json fehlt
  const FALLBACK_BOUNDS = { south: 47.399564822, west: 14.430844322, north: 49.044548178, east: 17.095640678 };

  // initialer Pixel-Shift (kannst du hier fest vorgeben)
  const DEFAULT_SHIFT_PX = 0;
  // ===========================================================================

  const toast = (msg) => { const el = document.getElementById('toast'); el.textContent = msg; el.style.display='block';
                           clearTimeout(el._t); el._t = setTimeout(()=> el.style.display='none', 2600); };

  const map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  async function loadBounds() {
    try {
      const r = await fetch('overlay_bounds.json', { cache: 'no-store' });
      if (!r.ok) throw 0;
      const b = await r.json();
      if (['south','west','north','east'].every(k => typeof b[k] === 'number')) return b;
    } catch {}
    return FALLBACK_BOUNDS;
  }

  (async function init(){
    const B = await loadBounds();

    // Basis-Bounds (unverschoben)
    const baseBounds = L.latLngBounds([B.south, B.west], [B.north, B.east]);
    let rect; // optionaler roter Bounds-Rahmen

    // Overlay anlegen (mit Cache-Buster)
    const overlay = L.imageOverlay(PNG_URL + '?v=' + Date.now(), baseBounds, { opacity: 0.85, crossOrigin: '' }).addTo(map);
    map.fitBounds(baseBounds.pad(0.1));
    overlay.on('load', () => toast('Overlay geladen'));
    overlay.on('error', () => toast('Overlay nicht gefunden ‚Äì Dateiname/Ort pr√ºfen'));

    // Opazit√§t
    const op = document.getElementById('opacity'), ovv = document.getElementById('ovv');
    const setOp = () => { const v = Number(op.value)/100; overlay.setOpacity(v); ovv.textContent = op.value + '%'; };
    op.addEventListener('input', setOp); setOp();

    // === Horizontale Feinjustierung (Pixel -> L√§ngengrad) ===================
    const pxVal = document.getElementById('pxVal');
    const btnL = document.getElementById('left');
    const btnR = document.getElementById('right');

    let shiftPx = Number(localStorage.getItem('overlayShiftPx') ?? DEFAULT_SHIFT_PX) || 0;
    pxVal.textContent = shiftPx;

    function applyShift(px) {
      // Bildbreite auslesen ‚Üí Grad/Pixel
      const wpx = overlay._image?.naturalWidth || 0;
      if (!wpx) return; // erst anwenden, wenn Bild geladen ist
      const lonPerPx = (B.east - B.west) / wpx;
      const dLon = px * lonPerPx;

      const adj = L.latLngBounds(
        [B.south, B.west + dLon],
        [B.north, B.east  + dLon]
      );
      overlay.setBounds(adj);

      if (rect && document.getElementById('showBounds').checked) {
        // den Rahmen auf die aktuell gesetzten Bounds legen
        rect.setBounds(adj);
      }
    }

    const runApply = () => { pxVal.textContent = String(shiftPx); localStorage.setItem('overlayShiftPx', String(shiftPx)); applyShift(shiftPx); };

    // Beim ersten Bild-Ladevorgang anwenden
    overlay.once('load', runApply);

    // Buttons
    btnL.addEventListener('click', () => { shiftPx -= 1; runApply(); });
    btnR.addEventListener('click', () => { shiftPx += 1; runApply(); });

    // Optional: Pfeiltasten ‚Üê/‚Üí auf Desktop
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') { shiftPx -= 1; runApply(); }
      if (e.key === 'ArrowRight'){ shiftPx += 1; runApply(); }
    });

    // === Bounds-Rahmen toggeln ==============================================
    const showBounds = document.getElementById('showBounds');
    showBounds.addEventListener('change', () => {
      if (showBounds.checked) {
        // Rahmen √ºber den aktuell gesetzten Overlay-Bounds zeichnen
        const current = overlay._bounds || baseBounds;
        rect = L.rectangle(current, { color: 'red', weight: 1 }).addTo(map);
      } else if (rect) {
        map.removeLayer(rect); rect = null;
      }
    });

    // Ansicht zur√ºcksetzen
    document.getElementById('reset').addEventListener('click', ()=> map.fitBounds((overlay._bounds || baseBounds).pad(0.1)));

    // === Geolocation: einmaliger Prompt, dann Watch =========================
    let watchId = null, gpsMarker = null, accCircle = null, firstFix = true;

    function startWatch(){
      if (watchId !== null) return;
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (!gpsMarker) {
          gpsMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("Du bist hier");
        }
        gpsMarker.setLatLng([latitude, longitude]);
        if (accCircle) map.removeLayer(accCircle);
        accCircle = L.circle([latitude, longitude], accuracy, {opacity:0.6, fillOpacity:0.08}).addTo(map);
        if (firstFix) { map.setView([latitude, longitude], Math.max(map.getZoom(), 12)); firstFix = false; }
      }, err => {
        if (err.code === err.PERMISSION_DENIED) {
          toast("Standort verweigert. Safari: aA ‚Üí Website-Einstellungen ‚Üí Standort: Erlauben");
        } else {
          toast("GPS-Fehler: " + err.message);
        }
      }, { enableHighAccuracy:true, maximumAge:10000, timeout:15000 });
    }

    async function requestOnceThenWatch(){
      try {
        await new Promise((res, rej) => {
          navigator.geolocation.getCurrentPosition(() => res(), e => rej(e),
            { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
        });
        startWatch();
        document.getElementById('loc').textContent = "üìç GPS aktiv";
        toast("GPS aktiv");
      } catch (e) {
        if (e && e.code === e.PERMISSION_DENIED) {
          toast("Standort blockiert. iOS: Ortungsdienste f√ºr Safari freigeben.");
        } else {
          toast("GPS-Fehler: " + (e?.message || e));
        }
      }
    }

    document.getElementById('loc').addEventListener('click', () => {
      if (!('geolocation' in navigator)) { toast("Geolocation nicht verf√ºgbar"); return; }
      if (watchId === null) {
        requestOnceThenWatch();
      } else {
        navigator.geolocation.clearWatch(watchId);
        watchId = null; firstFix = true;
        if (gpsMarker) { map.removeLayer(gpsMarker); gpsMarker = null; }
        if (accCircle) { map.removeLayer(accCircle); accCircle = null; }
        document.getElementById('loc').textContent = "üìç Meine Position";
        toast("GPS aus");
      }
    });

    // Manuelle Positionshilfe (Tap setzt Marker)
    let manual = null;
    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (!manual) {
        manual = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup("Manuell gesetzt");
      } else {
        manual.setLatLng([lat, lng]);
      }
    });
  })();
  </script>
</body>
</html>
