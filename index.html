<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>N√ñ ‚Ä¢ 14-Tage-Niederschlag</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <style>
    :root{
      --pad: max(12px, env(safe-area-inset-top, 0));
    }
    html,body,#map{height:100%;margin:0}
    .stack-left{
      position:fixed; z-index:1000;
      top: calc(env(safe-area-inset-top, 0) + 12px);
      left: calc(env(safe-area-inset-left, 0) + 12px);
      display:flex; flex-direction:column; gap:8px;
    }
    .btn{
      background:#fff; padding:8px 12px; border-radius:10px; border:1px solid #e5e5e5;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
      font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:14px;
    }
    /* schwebender Gear-Button */
    #fab{
      position:fixed; z-index:1001;
      top: calc(env(safe-area-inset-top, 0) + 12px);
      right: calc(env(safe-area-inset-right, 0) + 12px);
      width:42px; height:42px; border-radius:50%;
      display:grid; place-items:center;
    }
    /* einklappbares Panel (Drawer) */
    #drawer{
      position:fixed; z-index:1000;
      top: calc(env(safe-area-inset-top, 0) + 60px);
      right: calc(env(safe-area-inset-right, 0) + 12px);
      width:min(320px, 92vw); max-height:70vh; overflow:auto;
      background:#fff; border:1px solid #e5e5e5; border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      transform: translateX(110%); transition: transform .22s ease-out;
      padding:10px 12px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:14px;
    }
    #drawer.open{ transform:none; }
    #drawer .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:8px; }
    #drawer .kb{ min-width:32px; height:28px; border:1px solid #ddd; border-radius:6px; background:#fafafa }
    #drawer code{ background:#f3f3f3; padding:1px 6px; border-radius:4px }
    #toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%); z-index:1002;
      background:#111; color:#fff; padding:8px 12px; border-radius:8px; opacity:.92; display:none;
      font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:13px;
    }
    label{font-size:12px}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Linke Buttons (gestapelt, kein Overlap) -->
  <div class="stack-left">
    <button class="btn" id="loc">üìç Meine Position</button>
    <button class="btn" id="reset">‚Ü∫ Ansicht/Reset</button>
  </div>

  <!-- Gear zum √ñffnen/Schlie√üen -->
  <button class="btn" id="fab" aria-label="Einstellungen">‚öôÔ∏è</button>

  <!-- Einklappbares Korrektur-Panel -->
  <div id="drawer" aria-hidden="true">
    <div class="row">
      <label>Overlay
        <input type="range" id="opacity" min="30" max="100" value="85">
        <span id="ovv">85%</span>
      </label>
    </div>

    <div class="row">
      <label><input type="checkbox" id="showBounds"> Bounds-Rahmen</label>
    </div>

    <div class="row">
      <small>Shift X:</small>
      <button class="kb" id="left">‚Üê</button>
      <div><code id="pxX">0</code>&nbsp;px</div>
      <button class="kb" id="right">‚Üí</button>
    </div>

    <div class="row">
      <small>Shift Y:</small>
      <button class="kb" id="up">‚Üë</button>
      <div><code id="pxY">0</code>&nbsp;px</div>
      <button class="kb" id="down">‚Üì</button>
      <small style="opacity:.6">(‚Üë = nach Norden)</small>
    </div>

    <div class="row">
      <small>Breite (W):</small>
      <button class="kb" id="wMinus">W‚àí</button>
      <div><code id="wPct">0.0</code>&nbsp;%</div>
      <button class="kb" id="wPlus">W+</button>
    </div>

    <div class="row">
      <small>H√∂he (H):</small>
      <button class="kb" id="hMinus">H‚àí</button>
      <div><code id="hPct">0.0</code>&nbsp;%</div>
      <button class="kb" id="hPlus">H+</button>
    </div>
  </div>

  <div id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
  // ===== KONFIG ==============================================================
  const PNG_URL = "noe_rr_sum_2025-08-14_bis_2025-08-27.png";
  const FALLBACK_BOUNDS = { south: 47.399564822, west: 14.430844322, north: 49.044548178, east: 17.095640678 };
  // Optional: deine gefundenen Defaults hier eintragen (z.B. scaleW: 2.5)
  const DEFAULTS = { shiftX: 0, shiftY: 0, scaleW: 2.5, scaleH: 0.0 }; // px, px, %, %
  const STEP = { shift: 1, scale: 0.5 }; // 1 px / 0.5 %
  // ===========================================================================

  const toast = (msg) => { const el = document.getElementById('toast'); el.textContent = msg; el.style.display='block';
                           clearTimeout(el._t); el._t = setTimeout(()=> el.style.display='none', 2200); };

  const map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom: 19, attribution: '&copy; OpenStreetMap'}).addTo(map);

  async function loadBounds() {
    try {
      const r = await fetch('overlay_bounds.json', { cache: 'no-store' });
      if (!r.ok) throw 0;
      const b = await r.json();
      if (['south','west','north','east'].every(k => typeof b[k] === 'number')) return b;
    } catch {}
    return FALLBACK_BOUNDS;
  }

  (async function init(){
    const base = await loadBounds();
    const baseBounds = L.latLngBounds([base.south, base.west], [base.north, base.east]);

    // Drawer open/close
    const fab = document.getElementById('fab');
    const drawer = document.getElementById('drawer');
    const toggleDrawer = () => {
      const open = !drawer.classList.contains('open');
      drawer.classList.toggle('open', open);
      drawer.setAttribute('aria-hidden', String(!open));
    };
    fab.addEventListener('click', toggleDrawer);

    // Overlay
    const overlay = L.imageOverlay(PNG_URL + '?v=' + Date.now(), baseBounds, { opacity: 0.85, crossOrigin: '' }).addTo(map);
    map.fitBounds(baseBounds.pad(0.1));
    overlay.on('load', () => toast('Overlay geladen'));
    overlay.on('error', () => toast('Overlay nicht gefunden ‚Äì Dateiname/Ort pr√ºfen'));

    // Transparenz
    const op = document.getElementById('opacity'), ovv = document.getElementById('ovv');
    const setOp = () => { const v = Number(op.value)/100; overlay.setOpacity(v); ovv.textContent = op.value + '%'; };
    op.addEventListener('input', setOp); setOp();

    // Bounds-Rahmen
    const showBounds = document.getElementById('showBounds');
    let rect = null;
    showBounds.addEventListener('change', () => {
      if (showBounds.checked) {
        rect = L.rectangle(overlay._bounds || baseBounds, { color: 'red', weight: 1 }).addTo(map);
      } else if (rect) {
        map.removeLayer(rect); rect = null;
      }
    });

    // Justage-State (persistiert)
    const pxX = document.getElementById('pxX'), pxY = document.getElementById('pxY');
    const wPct = document.getElementById('wPct'), hPct = document.getElementById('hPct');
    let state = {
      shiftX: Number(localStorage.getItem('ovShiftX') ?? DEFAULTS.shiftX) || 0,
      shiftY: Number(localStorage.getItem('ovShiftY') ?? DEFAULTS.shiftY) || 0,
      scaleW: Number(localStorage.getItem('ovScaleW') ?? DEFAULTS.scaleW) || 0,
      scaleH: Number(localStorage.getItem('ovScaleH') ?? DEFAULTS.scaleH) || 0,
    };
    const updateUI = () => { pxX.textContent = state.shiftX; pxY.textContent = state.shiftY;
                             wPct.textContent = state.scaleW.toFixed(1); hPct.textContent = state.scaleH.toFixed(1); };

    function applyTransform() {
      const B = base;
      const wdeg0 = (B.east - B.west);
      const hdeg0 = (B.north - B.south);
      const cx = B.west + wdeg0/2;
      const cy = B.south + hdeg0/2;

      // Skalierung (zentriert)
      const wdeg = wdeg0 * (1 + state.scaleW / 100);
      const hdeg = hdeg0 * (1 + state.scaleH / 100);

      // Pixel -> Grad f√ºr Verschiebung (bezogen auf Originalbreite/H√∂he)
      const wpx = overlay._image?.naturalWidth  || 0;
      const hpx = overlay._image?.naturalHeight || 0;
      const lonPerPx = wpx ? (wdeg0 / wpx) : 0;
      const latPerPx = hpx ? (hdeg0 / hpx) : 0;

      const dLon = state.shiftX * lonPerPx;
      const dLat = state.shiftY * latPerPx;

      const west  = (cx - wdeg/2) + dLon;
      const east  = (cx + wdeg/2) + dLon;
      const south = (cy - hdeg/2) + dLat;
      const north = (cy + hdeg/2) + dLat;

      const adj = L.latLngBounds([south, west], [north, east]);
      overlay.setBounds(adj);
      if (rect && showBounds.checked) rect.setBounds(adj);
    }

    // Buttons/Keyboard
    const STEP = { shift: 1, scale: 0.5 };
    document.getElementById('left').addEventListener('click',  () => { state.shiftX -= STEP.shift; persist(); });
    document.getElementById('right').addEventListener('click', () => { state.shiftX += STEP.shift; persist(); });
    document.getElementById('up').addEventListener('click',    () => { state.shiftY += STEP.shift; persist(); });
    document.getElementById('down').addEventListener('click',  () => { state.shiftY -= STEP.shift; persist(); });
    document.getElementById('wMinus').addEventListener('click',() => { state.scaleW -= STEP.scale; persist(); });
    document.getElementById('wPlus').addEventListener('click', () => { state.scaleW += STEP.scale; persist(); });
    document.getElementById('hMinus').addEventListener('click',() => { state.scaleH -= STEP.scale; persist(); });
    document.getElementById('hPlus').addEventListener('click', () => { state.scaleH += STEP.scale; persist(); });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft')  { state.shiftX -= STEP.shift; persist(); }
      if (e.key === 'ArrowRight') { state.shiftX += STEP.shift; persist(); }
      if (e.key === 'ArrowUp')    { state.shiftY += STEP.shift; persist(); }
      if (e.key === 'ArrowDown')  { state.shiftY -= STEP.shift; persist(); }
      if (e.key === 'w')          { state.scaleW += STEP.scale; persist(); }
      if (e.key === 'W')          { state.scaleW -= STEP.scale; persist(); }
      if (e.key === 'h')          { state.scaleH += STEP.scale; persist(); }
      if (e.key === 'H')          { state.scaleH -= STEP.scale; persist(); }
    });

    function persist() {
      localStorage.setItem('ovShiftX', String(state.shiftX));
      localStorage.setItem('ovShiftY', String(state.shiftY));
      localStorage.setItem('ovScaleW', String(state.scaleW));
      localStorage.setItem('ovScaleH', String(state.scaleH));
      updateUI(); applyTransform();
    }
    updateUI();

    // Reset-Button links
    document.getElementById('reset').addEventListener('click', () => {
      state = { ...DEFAULTS };
      persist();
      map.fitBounds((overlay._bounds || baseBounds).pad(0.1));
      toast("Zur√ºckgesetzt");
    });

    // Geolocation
    let watchId = null, gpsMarker = null, accCircle = null, firstFix = true;
    function startWatch(){
      if (watchId !== null) return;
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (!gpsMarker) gpsMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("Du bist hier");
        gpsMarker.setLatLng([latitude, longitude]);
        if (accCircle) map.removeLayer(accCircle);
        accCircle = L.circle([latitude, longitude], accuracy, {opacity:0.6, fillOpacity:0.08}).addTo(map);
        if (firstFix) { map.setView([latitude, longitude], Math.max(map.getZoom(), 12)); firstFix = false; }
      }, err => {
        if (err.code === err.PERMISSION_DENIED) toast("Standort verweigert. Safari: aA ‚Üí Website-Einstellungen ‚Üí Standort: Erlauben");
        else toast("GPS-Fehler: " + err.message);
      }, { enableHighAccuracy:true, maximumAge:10000, timeout:15000 });
    }
    async function requestOnceThenWatch(){
      try {
        await new Promise((res, rej) => {
          navigator.geolocation.getCurrentPosition(() => res(), e => rej(e),
            { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
        });
        startWatch();
        document.getElementById('loc').textContent = "üìç GPS aktiv";
        toast("GPS aktiv");
      } catch (e) {
        if (e && e.code === e.PERMISSION_DENIED) toast("Standort blockiert. iOS: Ortungsdienste f√ºr Safari freigeben.");
        else toast("GPS-Fehler: " + (e?.message || e));
      }
    }
    document.getElementById('loc').addEventListener('click', () => {
      if (!('geolocation' in navigator)) { toast("Geolocation nicht verf√ºgbar"); return; }
      if (watchId === null) requestOnceThenWatch();
      else {
        navigator.geolocation.clearWatch(watchId);
        watchId = null; firstFix = true;
        if (gpsMarker) { map.removeLayer(gpsMarker); gpsMarker = null; }
        if (accCircle) { map.removeLayer(accCircle); accCircle = null; }
        document.getElementById('loc').textContent = "üìç Meine Position";
        toast("GPS aus");
      }
    });

    // Manuelle Positionshilfe (Tap setzt Marker)
    let manual = null;
    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (!manual) manual = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup("Manuell gesetzt");
      else manual.setLatLng([lat, lng]);
    });
  })();
  </script>
</body>
</html>
